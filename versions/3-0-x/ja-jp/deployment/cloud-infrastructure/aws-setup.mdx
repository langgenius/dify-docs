---
title: AWS ãƒ‡ãƒ—ãƒ­ã‚¤ã‚¬ã‚¤ãƒ‰
---

# Dify Enterprise Edition ãƒ‡ãƒ—ãƒ­ã‚¤ã‚¬ã‚¤ãƒ‰ (AWS)

Dify Enterprise Edition ã‚’å††æ»‘ã«ãƒ‡ãƒ—ãƒ­ã‚¤ã™ã‚‹ãŸã‚ã€ä»¥ä¸‹ã®ã‚¤ãƒ³ãƒ•ãƒ©è¦ä»¶ãŠã‚ˆã³è¨­å®šæ‰‹é †ã«å¾“ã£ã¦ãã ã•ã„ã€‚

---

## æ³¨æ„äº‹é …

**â€¼ï¸å¿…ãšãƒãƒ¼ã‚¸ãƒ§ãƒ³ 2.8.0 ä»¥ä¸Šã¸ã‚¢ãƒƒãƒ—ã‚°ãƒ¬ãƒ¼ãƒ‰ã—ã€ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚’å®Œäº†ã•ã›ã¦ãã ã•ã„ã€‚**â€¼ï¸

---

## 1. ã‚¤ãƒ³ãƒ•ãƒ©è¦ä»¶

### å¿…é ˆ AWS ã‚µãƒ¼ãƒ“ã‚¹:

- **S3**
- **ECR**

### ã‚µãƒãƒ¼ãƒˆã•ã‚Œã‚‹èªè¨¼æ–¹å¼:

Dify ã¯ã€AWS ã‚µãƒ¼ãƒ“ã‚¹ã¸ã®ã‚¢ã‚¯ã‚»ã‚¹ã«ä»¥ä¸‹ã® 2 ã¤ã®æ–¹å¼ã‚’ã‚µãƒãƒ¼ãƒˆã—ã¾ã™:

- **ã‚¢ã‚¯ã‚»ã‚¹ã‚­ãƒ¼æ–¹å¼ (AK/SK):** ç’°å¢ƒå¤‰æ•°ã‚’é€šã˜ã¦èªè¨¼æƒ…å ±ã‚’æä¾›
- **IRSA æ–¹å¼:** IAM Roles for Service Accounts ã‚’ç”¨ã„ãŸã‚»ã‚­ãƒ¥ã‚¢ã‹ã¤ãã‚ç´°ã‹ã„ã‚¢ã‚¯ã‚»ã‚¹åˆ¶å¾¡

---

## 2. ã‚¢ã‚¯ã‚»ã‚¹ã‚­ãƒ¼æ–¹å¼

### Step 1: èªè¨¼æƒ…å ±ã®æº–å‚™

**S3** ã¨ **ECR** ã®æ¨©é™ã®ã¿ã‚’æŒã¤ IAM ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’ä½œæˆã—ã€Access Key ã¨ Secret Key ã‚’å–å¾—ã—ã¾ã™ã€‚

### Step 2: Kubernetes Secret ã®ä½œæˆ

````bash
kubectl create secret generic image-repo-secret --from-file=<path to .aws/credentials>
````

### **Step 3:** **values.yaml ã®æ›´æ–°**

```bash
persistence:
  type: "s3"
  s3:
    endpoint: "https://s3.{region_code}.amazonaws.com"
    region: "{region_code}"
    bucketName: "your_bucket_name"
    useAwsS3: true
    useAwsManagedIam: false
    accessKey: "{your access key}"
    secretKey: "{your secret key}"

plugin_daemon:
  enabled: true
  replicas: 1
  apiKey: "dify123456"

plugin_connector:
  apiKey: "dify123456"
  imageRepoSecret: "image-repo-secret"
  imageRepoPrefix: "{account_id}.dkr.ecr.{region}.amazonaws.com/dify-ee"
  imageRepoType: ecr
  ecrRegion: "us-west-2"
```



### **Step 4: Plugin Daemon ã®ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹è¨­å®š**

```bash
externalPostgres:
  enabled: true
  address: "rds_address"
  port: "5432"
  credentials:
    plugin_daemon:
      database: "dify_plugin_daemon"
      username: "{user}"
      password: "{password}"
      sslmode: "disable"
```

### **Step 5:** 

### **ãƒªãƒªãƒ¼ã‚¹ãƒãƒ¼ãƒˆã«å¾“ã£ã¦ã‚¢ãƒƒãƒ—ã‚°ãƒ¬ãƒ¼ãƒ‰ï¼ˆã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ï¼‰**

https://langgenius.github.io/dify-helm/#/pages/3_0_0

------

## **3. IRSA ãƒ¢ãƒ¼ãƒ‰**

Access Key ã¯ä¼æ¥­ç’°å¢ƒã§å³æ ¼ã«ç®¡ç†ã•ã‚Œã‚‹ãŸã‚ã€AWS Pod Identity (IRSA) ã®åˆ©ç”¨ã‚’æ¨å¥¨ã—ã¾ã™ã€‚

### **âœ… åˆ©ç‚¹**

- AWS ã®ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ™ã‚¹ãƒˆãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹ã«æº–æ‹ 
- ãƒ—ãƒ©ã‚°ã‚¤ãƒ³å®Ÿè¡Œç’°å¢ƒã®ãã‚ç´°ã‹ãªåˆ¶å¾¡ãŒå¯èƒ½

### **ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—**

#### **Step 1: IAM ãƒ­ãƒ¼ãƒ«ã¨ Service Account ã®æº–å‚™**

- ##### **å‰ææ¡ä»¶**

  - åˆ©ç”¨å¯èƒ½ãª AWS ãƒªãƒ¼ã‚¸ãƒ§ãƒ³ãŠã‚ˆã³ EKS ã‚¯ãƒ©ã‚¹ã‚¿ãƒ¼ãŒå­˜åœ¨ã™ã‚‹ã“ã¨
  - Dify ã®ãƒ•ã‚¡ã‚¤ãƒ«ä¿å­˜ç”¨ã®æ—¢å­˜ã® S3 ãƒã‚±ãƒƒãƒˆãŒã‚ã‚‹ã“ã¨
  - kubectl ãŒãƒ­ãƒ¼ã‚«ãƒ«ã«ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ãƒ»è¨­å®šã•ã‚Œã€å¯¾è±¡ EKS ã‚¯ãƒ©ã‚¹ã‚¿ãƒ¼ã¸ã‚¢ã‚¯ã‚»ã‚¹ã§ãã‚‹ã“ã¨
  - AWS CLI ãŒã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã•ã‚Œã€ãƒ­ãƒ¼ã‚«ãƒ«ã«èªè¨¼æƒ…å ±ãŒè¨­å®šã•ã‚Œã¦ã„ã‚‹ã“ã¨

##### **ğŸš€ã‚ªãƒ—ã‚·ãƒ§ãƒ³ A: ãƒ¯ãƒ³ã‚¯ãƒªãƒƒã‚¯ã‚¹ã‚¯ãƒªãƒ—ãƒˆã®å®Ÿè¡Œ**

â€‹	**â€¼ï¸ ãƒ¯ãƒ³ã‚¯ãƒªãƒƒã‚¯ã‚¹ã‚¯ãƒªãƒ—ãƒˆã¯ãƒ‡ãƒ¢ãŠã‚ˆã³ãƒ†ã‚¹ãƒˆç”¨ã§ã™ã€‚å®Ÿé‹ç”¨ã«åˆã‚ã›ã¦ç‹¬è‡ªã®ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’é–‹ç™ºã—ã¦ãã ã•ã„ã€‚ã“ã®ãƒ‡ãƒ¢ã‚¹ã‚¯ãƒªãƒ—ãƒˆã¯ Dify FDE ãƒãƒ¼ãƒ ã‹ã‚‰å…¥æ‰‹å¯èƒ½ã§ã™ã€‚**

```
./irsa_one_click.sh
```

##### **ğŸ”¨ã‚ªãƒ—ã‚·ãƒ§ãƒ³ B: æ‰‹å‹•è¨­å®š**

1. **EKS ã‚¯ãƒ©ã‚¹ã‚¿ãƒ¼ã§ IAM OIDC ãƒ—ãƒ­ãƒã‚¤ãƒ€ã‚’æœ‰åŠ¹åŒ–**

   EKS ã‚¯ãƒ©ã‚¹ã‚¿ãƒ¼ã¨ OIDC ID ãƒ—ãƒ­ãƒã‚¤ãƒ€ã‚’é–¢é€£ä»˜ã‘ã‚‹ãŸã‚ã«ã€[AWSå…¬å¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ](https://docs.aws.amazon.com/eks/latest/userguide/enable-iam-roles-for-service-accounts.html) ã®æ‰‹é †ã«å¾“ã£ã¦ãã ã•ã„ã€‚ã“ã®æ‰‹é †ã‚’å®Œäº†ã—ãªã„ã¨ã€IRSA ã‚’åˆ©ç”¨ã§ãã¾ã›ã‚“ã€‚

2. **IAM ãƒãƒªã‚·ãƒ¼ã®ä½œæˆ**

| **é …ç›®**        | **ä¾‹ã®å‘½å**                                     | **èª¬æ˜**                                                     |
| --------------- | ------------------------------------------------ | ------------------------------------------------------------ |
| S3 Policy Name  | `dify-ee-irsa-<cluster_name>-s3-policy`            | æŒ‡å®šã—ãŸ S3 ãƒã‚±ãƒƒãƒˆã¸ã®å®Œå…¨ã‚¢ã‚¯ã‚»ã‚¹                         |
| ECR Policy Name | `dify-ee-irsa-<cluster_name>-ecr-policy`           | ECR ã¸ã®å®Œå…¨ã‚¢ã‚¯ã‚»ã‚¹ãŠã‚ˆã³ CloudTrail ã®èª­ã¿å–ã‚Šå°‚ç”¨ã‚¢ã‚¯ã‚»ã‚¹ |
| ECR Policy Name | `dify-ee-irsa-<cluster_name>-ecr-pull-only-policy` | ECR ã‹ã‚‰ã® pull ã®ã¿è¨±å¯                                     |

1. **ãƒãƒªã‚·ãƒ¼ä»˜ã IAM ãƒ­ãƒ¼ãƒ«ã®ä½œæˆ**

| **é …ç›®**                 | **ä¾‹ã®å‘½å**                              | **policy**                                                   |
| ------------------------ | ----------------------------------------- | ------------------------------------------------------------ |
| IAM Role - S3            | `DifyEE-Role-<cluster_name>-s3`             | `dify-ee-irsa-<cluster_name>-s3-policy`                        |
| IAM Role - S3 + ECR      | `DifyEE-Role-<cluster_name>-s3-ecr`         | `dify-ee-irsa-<cluster_name>-s3-policy` `dify-ee-irsa-<cluster_name>-ecr-policy` |
| IAM Role - ECR Pull-only | `DifyEE-Role-<cluster_name>-ecr-image-pull` | `dify-ee-irsa-<cluster_name>-ecr-pull-only-policy`             |

1. **IAM ãƒ­ãƒ¼ãƒ«ã‚’ ServiceAccount ã«é–¢é€£ä»˜ã‘**

| **ç”¨é€”**                   | **ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå**      | **ãƒã‚¤ãƒ³ãƒ‰ã™ã‚‹ IAM ãƒ­ãƒ¼ãƒ«**               | **èª¬æ˜**                                                     |
| -------------------------- | --------------------- | ----------------------------------------- | ------------------------------------------------------------ |
| dify-api, dify-worker ç”¨   | dify-api-sa           | `DifyEE-Role-<cluster_name>-s3`             | ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã‚µãƒ¼ãƒ“ã‚¹ãŒ S3 ã«ã‚¢ã‚¯ã‚»ã‚¹ï¼ˆãƒ•ã‚¡ã‚¤ãƒ«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ãªã©ï¼‰ |
| dify-plugin-crd ã®ãƒ“ãƒ«ãƒ‰ç”¨ | dify-plugin-crd-sa    | `DifyEE-Role-<cluster_name>-s3-ecr`         | S3 ã¸ã®ã‚¢ã‚¯ã‚»ã‚¹ã‚„ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã‚¤ãƒ¡ãƒ¼ã‚¸ãƒ¬ãƒã‚¸ãƒˆãƒªã®æ“ä½œã‚’è¡Œã†    |
| dify-plugin å®Ÿè¡Œæ™‚ç”¨       | dify-plugin-runner-sa | `DifyEE-Role-<cluster_name>-ecr-image-pull` | ãƒ—ãƒ©ã‚°ã‚¤ãƒ³å®Ÿè¡Œæ™‚ã®ã‚¤ãƒ¡ãƒ¼ã‚¸ pull ã«åˆ©ç”¨                       |

#### **Step 2: ç’°å¢ƒå¤‰æ•°ã®è¨­å®š**

ãƒªãƒªãƒ¼ã‚¹ãƒãƒ¼ãƒˆã«å¾“ã£ã¦ã€S3_REGIONã€S3_BUCKET_NAME ãªã©ã®ç’°å¢ƒå¤‰æ•°ã‚’è¨­å®šã—ã¾ã™ã€‚

#### **Step 3:** **values.yamlã®æ›´æ–°**

```bash
persistence:
  type: "s3"
  s3:
    endpoint: "https://s3.{region_code}.amazonaws.com"
    region: "{region_code}"
    bucketName: "your_bucket_name"
    useAwsS3: true
    useAwsManagedIam: true

api:
  enabled: true
  replicas: 1
  innerApi:
    enabled: true
    apiKey: "dify123456"
  serverWorkerAmount: 1
  serviceAccountName: "dify-api-sa"

worker:
  enabled: true
  replicas: 1
  serviceAccountName: "dify-api-sa"

plugin_daemon:
  enabled: true
  replicas: 1
  apiKey: "dify123456"

plugin_connector:
  apiKey: "dify123456"
  customServiceAccount: "dify-plugin-build-sa"
  runnerServiceAccount: "dify-plugin-build-run-sa"
  imageRepoPrefix: "{account_id}.dkr.ecr.{region}.amazonaws.com/dify-ee"
  imageRepoType: ecr
  ecrRegion: "us-west-2"
```

#### **Step 4: Plugin Daemon ã®ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹è¨­å®š**

```bash
externalPostgres:
  enabled: true
  address: "rds_address"
  port: "5432"
  credentials:
    plugin_daemon:
      database: "dify_plugin_daemon"
      username: "{user}"
      password: "{password}"
      sslmode: "disable"
```

#### **Step 5:** **ãƒªãƒªãƒ¼ã‚¹ãƒãƒ¼ãƒˆã«å¾“ã£ã¦ã‚¢ãƒƒãƒ—ã‚°ãƒ¬ãƒ¼ãƒ‰ï¼ˆã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ï¼‰**

https://langgenius.github.io/dify-helm/#/pages/3_0_0

#### **Step 6: ã‚«ã‚¹ã‚¿ãƒ  ServiceAccount ã« S3 æ¨©é™ã‚’ä»˜ä¸**

ServiceAccount å: dify-plugin-connector-sa

```bash
kubectl annotate serviceaccount -n {namespace} dify-plugin-connector-sa eks.amazonaws.com/role-arn={arn_of_IAM_S3}
```

ã‚‚ã— ./irsa_one_click.sh ã‚’ä½¿ã£ã¦ S3 ã®èª­ã¿æ›¸ãã®ãƒ­ãƒ¼ãƒ«ã‚’ä½œæˆã—ãŸå ´åˆã€ã“ã® ARN ã¯ã‚¹ã‚¯ãƒªãƒ—ãƒˆå®Ÿè¡Œã®æœ€å¾Œã«è¡¨ç¤ºã•ã‚Œã¾ã™ã€‚

#### **Step 7: Dify Daemon Pod ã‚’å†èµ·å‹•**

```bash
kubectl delete pod {dify-plugin-daemon_name}
```

## **Notes**

- âŒ **Redis ã‚¯ãƒ©ã‚¹ã‚¿ãƒ¼ãƒ¢ãƒ¼ãƒ‰ã¯ã‚µãƒãƒ¼ãƒˆã•ã‚Œã¦ã„ã¾ã›ã‚“**
- ğŸŒ EKS ãƒãƒ¼ãƒ‰ã¯ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒƒãƒˆã‚¢ã‚¯ã‚»ã‚¹ãŒå¯èƒ½ã€ã¾ãŸã¯ NAT Gateway ã®èƒŒå¾Œã«é…ç½®ã•ã‚Œã¦ã„ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™