---
title: AWS éƒ¨ç½²æŒ‡å—
version: 'ç®€ä½“ä¸­æ–‡'

---

# Dify Enterprise Edition éƒ¨ç½²æŒ‡å—ï¼ˆAWSï¼‰

ä¸ºç¡®ä¿é¡ºåˆ©éƒ¨ç½² Dify ä¼ä¸šç‰ˆï¼Œè¯·æŒ‰ç…§ä»¥ä¸‹åŸºç¡€è®¾æ–½ä¸é…ç½®è¯´æ˜è¿›è¡Œæ“ä½œã€‚

---

## ä¸€ã€åŸºç¡€è®¾æ–½è¦æ±‚

### éœ€è¦æƒé™çš„ AWS æœåŠ¡ï¼š

- **S3**
- **ECR**

### æ”¯æŒçš„è®¤è¯æ–¹å¼ï¼š

Dify æ”¯æŒä»¥ä¸‹ä¸¤ç§æ–¹å¼è®¿é—® AWS æœåŠ¡ï¼š

- **Access Key æ¨¡å¼ï¼ˆAK/SKï¼‰**ï¼šé€šè¿‡ç¯å¢ƒå˜é‡æä¾›å‡­è¯
- **IRSA æ¨¡å¼**ï¼šIAM Roles for Service Accountsï¼Œå®ç°æ›´å®‰å…¨ã€ç²¾ç»†çš„æƒé™æ§åˆ¶

---

## äºŒã€Access Key æ¨¡å¼é…ç½®

### æ­¥éª¤ 1ï¼šå‡†å¤‡å‡­è¯

åˆ›å»ºä¸€ä¸ªåªå…·å¤‡ **S3** å’Œ **ECR** æƒé™çš„ IAM ç”¨æˆ·ï¼Œè·å–å…¶ Access Key å’Œ Secret Keyã€‚

### æ­¥éª¤ 2ï¼šåˆ›å»º Kubernetes Secret

```bash
kubectl create secret generic image-repo-secret --from-file=<path to .aws/credentials>
```

### æ­¥éª¤ 3ï¼šä¿®æ”¹ `values.yaml`

```yaml
persistence:
  type: "s3"
  s3:
    endpoint: "https://s3.{region_code}.amazonaws.com"
    region: "{region_code}"
    bucketName: "your_bucket_name"
    useAwsS3: true
    useAwsManagedIam: false
    accessKey: "{your access key}"
    secretKey: "{your secret key}"

# æ–°å¢ä¸¤ä¸ªæœåŠ¡ï¼š
plugin_daemon:
  enabled: true
  replicas: 1
  apiKey: "dify123456"

plugin_connector:
  apiKey: "dify123456"
  imageRepoSecret: "image-repo-secret"
  imageRepoPrefix: "{account_id}.dkr.ecr.{region}.amazonaws.com/dify-ee"
  imageRepoType: ecr
  ecrRegion: "us-west-2"
```

### æ­¥éª¤ 4ï¼šé…ç½® `dify_plugin_daemon` æ•°æ®åº“

```yaml
externalPostgres:
  enabled: true
  address: "rds_address"
  port: "5432"
  credentials:
    plugin_daemon:
      database: "dify_plugin_daemon"
      username: "{user}"
      password: "{password}"
      sslmode: "disable"
    audit:
      database: "audit"
      username: "{user}"
      password: "{password}"
      sslmode: "disable"
```

### æ­¥éª¤ 5ï¼šå‡çº§ Helm Release

```bash
helm upgrade dify dify/dify-ee -n default --version 3.0.0
```

---

## ä¸‰ã€IRSA æ¨¡å¼é…ç½®

ç”±äºä¼ä¸šç¯å¢ƒå¯¹ Access Key ç®¡æ§ä¸¥æ ¼ï¼Œæˆ‘ä»¬æ¨èä½¿ç”¨ AWS Pod Identity (IRSA) æ–¹å¼æ¥è®¿é—®èµ„æºã€‚

### âœ… ä¼˜åŠ¿

- éµå¾ª AWS æœ€ä½³å®‰å…¨å®è·µ
- å¯å¯¹æ’ä»¶æ‰§è¡Œç¯å¢ƒè¿›è¡Œç²¾ç»†åŒ–æƒé™ç®¡ç†

### ğŸª„ å¿«é€Ÿé…ç½®ï¼ˆæ¨èï¼‰

#### **æ­¥éª¤ 1ï¼šåˆ›å»º IAM Role å’Œ Service Account**

- ##### **å‰ç½®æ¡ä»¶**

  - å¯ç”¨çš„ AWS åŒºåŸŸä»¥åŠ EKS é›†ç¾¤
  - å·²å­˜åœ¨çš„ S3 Bucket ç”¨äº Dify æ–‡ä»¶å­˜å‚¨
  - æœ¬åœ°å·²å®‰è£…å¹¶é…ç½®å¥½ kubectlï¼Œå¯è®¿é—®ç›®æ ‡ EKS é›†ç¾¤
  - æœ¬åœ°å·²å®‰è£… AWS CLI å¹¶é…ç½®å¥½å‡­è¯

##### **ğŸš€ æ–¹æ¡ˆ Aï¼šè¿è¡Œä¸€é”®è„šæœ¬**

â€‹	**â€¼ï¸ ä¸€é”®è„šæœ¬ä»…ç”¨äºæ¼”ç¤ºå’Œæµ‹è¯•ï¼Œè¯·æ ¹æ®è‡ªå·±çš„å®‰å…¨è¦æ±‚ç¼–å†™ç”Ÿäº§è„šæœ¬ã€‚å¯å‘ Dify FDE å›¢é˜Ÿè·å–æ­¤æ¼”ç¤ºè„šæœ¬ã€‚**

```bash
./irsa_one_click.sh
```

##### **ğŸ”¨ æ–¹æ¡ˆ Bï¼šæ‰‹åŠ¨é…ç½®**

1. **ä¸º EKS é›†ç¾¤å¯ç”¨ IAM OIDC Provider**

   è¯·å‚è€ƒ [AWS å®˜æ–¹æ–‡æ¡£](https://docs.aws.amazon.com/eks/latest/userguide/enable-iam-roles-for-service-accounts.html)ï¼Œå°† EKS é›†ç¾¤ä¸ OIDC èº«ä»½æä¾›è€…å…³è”ã€‚æ­¤æ­¥éª¤æ˜¯ä½¿ç”¨ IRSA çš„å‰æã€‚

2. **åˆ›å»º IAM Policy**

   | **é¡¹ç›®**        | **ç¤ºä¾‹å‘½å**                                     | **æè¿°**                                    |
   | --------------- | ------------------------------------------------ | ------------------------------------------- |
   | S3 Policy åç§°  | `dify-ee-irsa-<cluster_name>-s3-policy`            | å¯¹æŒ‡å®š S3 Bucket å…·æœ‰å®Œå…¨è®¿é—®æƒé™           |
   | ECR Policy åç§° | `dify-ee-irsa-<cluster_name>-ecr-policy`           | å¯¹ ECR å®Œå…¨è®¿é—®æƒé™åŠå¯¹ CloudTrail åªè¯»æƒé™ |
   | ECR Policy åç§° | `dify-ee-irsa-<cluster_name>-ecr-pull-only-policy` | ä»…å…è®¸ä» ECR æ‹‰å–é•œåƒ                       |

3. **åˆ›å»ºå…³è” Policy çš„ IAM Role**

   | **é¡¹ç›®**                 | **ç¤ºä¾‹å‘½å**                              | **policy**                                                   |
   | ------------------------ | ----------------------------------------- | ------------------------------------------------------------ |
   | IAM Role - S3            | `DifyEE-Role-<cluster_name>-s3`             | `dify-ee-irsa-<cluster_name>-s3-policy`                        |
   | IAM Role - S3 + ECR      | `DifyEE-Role-<cluster_name>-s3-ecr`         | `dify-ee-irsa-<cluster_name>-s3-policy` å’Œ `dify-ee-irsa-<cluster_name>-ecr-policy` |
   | IAM Role - ECR Pull-only | `DifyEE-Role-<cluster_name>-ecr-image-pull` | `dify-ee-irsa-<cluster_name>-ecr-pull-only-policy`             |

4. **ä¸º IAM Role åˆ›å»º ServiceAccount**

   | **ç”¨é€”**                     | **é»˜è®¤åç§°**          | **ç»‘å®š IAM Role**                         | **æè¿°**                        |
   | ---------------------------- | --------------------- | ----------------------------------------- | ------------------------------- |
   | dify-apiã€dify-worker ä½¿ç”¨   | dify-api-sa           | `DifyEE-Role-<cluster_name>-s3`             | åç«¯æœåŠ¡è®¿é—® S3ï¼Œä¾‹å¦‚æ–‡ä»¶ä¸Šä¼ ç­‰ |
   | dify-plugin-crd é•œåƒæ„å»ºä½¿ç”¨ | dify-plugin-crd-sa    | `DifyEE-Role-<cluster_name>-s3-ecr`         | è®¿é—® S3 å¹¶æ“ä½œæ’ä»¶é•œåƒä»“åº“      |
   | dify-plugin è¿è¡Œæ—¶ä½¿ç”¨       | dify-plugin-runner-sa | `DifyEE-Role-<cluster_name>-ecr-image-pull` | ç”¨äºæ‹‰å–æ’ä»¶è¿è¡Œæ‰€éœ€é•œåƒ        |

#### æ­¥éª¤ 2ï¼šè®¾ç½®ç¯å¢ƒå˜é‡

æ ¹æ®ç‰ˆæœ¬å‘å¸ƒè¯´æ˜é…ç½®æ‰€éœ€å˜é‡ï¼ˆå¦‚ `S3_REGION`ã€`S3_BUCKET_NAME` ç­‰ï¼‰ã€‚

#### æ­¥éª¤ 3ï¼šä¿®æ”¹ `values.yaml`

```yaml
persistence:
  type: "s3"
  s3:
    endpoint: "https://s3.{region_code}.amazonaws.com"
    region: "{region_code}"
    bucketName: "your_bucket_name"
    useAwsS3: true
    useAwsManagedIam: true

api:
  enabled: true
  replicas: 1
  innerApi:
    enabled: true
    apiKey: "dify123456"
  serviceAccountName: "dify-api-sa"

worker:
  enabled: true
  replicas: 1
  serviceAccountName: "dify-api-sa"

plugin_daemon:
  enabled: true
  replicas: 1
  apiKey: "dify123456"

plugin_connector:
  apiKey: "dify123456"
  customServiceAccount: "dify-plugin-build-sa"
  runnerServiceAccount: "dify-plugin-build-run-sa"
  imageRepoPrefix: "{account_id}.dkr.ecr.{region}.amazonaws.com/dify-ee"
  imageRepoType: ecr
  ecrRegion: "us-west-2"
```

#### æ­¥éª¤ 4ï¼šæ·»åŠ æ’ä»¶æ•°æ®åº“é…ç½®

```yaml
externalPostgres:
  enabled: true
  address: "rds_address"
  port: "5432"
  credentials:
    plugin_daemon:
      database: "dify_plugin_daemon"
      username: "{user}"
      password: "{password}"
      sslmode: "disable"
    audit:
      database: "audit"
      username: "{user}"
      password: "{password}"
      sslmode: "disable"
```

#### æ­¥éª¤ 5ï¼šæ ¹æ®å‘å¸ƒæ—¥å¿—å‡çº§ï¼ˆå®‰è£…ï¼‰

https://langgenius.github.io/dify-helm/#/pages/3_0_0

#### æ­¥éª¤ 6ï¼šç»™åº”ç”¨è‡ªå»ºçš„ ServiceAccount å¢åŠ  S3 æƒé™

ServiceAccount åç§°ï¼š`dify-plugin-connector-sa`

```bash
kubesctl annotate serviceaccount -n {namespace} dify-plugin-connector-sa eks.amazonaws.com/role-arn={arn_of_IAM_S3}
```

å¦‚æœä½ ä½¿ç”¨`./irsa_one_click.sh` åˆ›å»ºäº† s3 è¯»å†™çš„è§’è‰² ï¼Œè¿™ä¸ª arn ä¼šå‡ºç°åœ¨è„šæœ¬æ‰§è¡Œçš„æœ«å°¾ã€‚

#### æ­¥éª¤7ï¼šé‡å¯ Dify Deamon Pod

```bash
kubectl delete pod {dify-plugin-daemon_name}
```

## æ³¨æ„äº‹é¡¹

- âŒ **ä¸æ”¯æŒ Redis Cluster æ¨¡å¼**
- ğŸŒ EKS èŠ‚ç‚¹éœ€èƒ½è®¿é—®äº’è”ç½‘æˆ–é…ç½® NAT Gateway

---
