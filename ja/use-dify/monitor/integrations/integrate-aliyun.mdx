---
title: Alibaba Cloud Monitorの統合
---

## Alibaba Cloud Monitorとは

Alibaba Cloudは、Difyアプリケーションのワンクリック監視、トレース、評価を可能にする、フルマネージドかつメンテナンス不要のオブザーバビリティプラットフォームを提供します。

<Info>
  Alibaba Cloud Monitorは、[LoongSuite](https://github.com/alibaba/loongsuite-python-agent)エージェントやオープンソースのOpenTelemetryエージェントを通じて、Python/Golang/Javaアプリケーションをネイティブにサポートします。Dify LLMアプリケーションのワンクリック監視に加え、非侵入型エージェントによるDifyコンポーネントおよびその上下流依存関係のエンドツーエンドの可観測性もサポートします。
  
  詳細は[Cloud Monitorドキュメント](https://www.alibabacloud.com/help/en/cms/cloudmonitor-1-0/product-overview/what-is-cloudmonitor?spm=a3c0i.63551.2277339270.1.76c7112eeKEvSr)をご参照ください。
</Info>

***

## Alibaba Cloud Monitorの設定方法

### 1. Alibaba Cloudのエンドポイントとライセンスキーの取得

1. [ARMSコンソール](https://account.alibabacloud.com/login/login.htm?spm=5176.12901015-2.0.0.68d74b84XRatpU)にログインし、左側のナビゲーションバーで**Integration Center**をクリックします。
2. **Server-side Applications**エリアで**OpenTelemetry**カードをクリックします。
3. 表示された**OpenTelemetry**パネルで、エクスポートプロトコルとして**gRPC**を選択し、実際のデプロイに応じて接続方法とリージョンを選択します。

![Alibaba Cloudアクセスポイントの取得](https://dify-public-resources.oss-cn-hangzhou.aliyuncs.com/dify-doc/get_endpoint.png)

4. **Public Endpoint**と**Authentication Token (License Key)**を保存します。

<Note>
  エンドポイントにはポート番号が含まれていません（例: `http://tracing-cn-heyuan.arms.aliyun.com`）。
</Note>

### 2. DifyでCloud Monitorを設定

<Info>
  **前提条件**: Dify CloudまたはCommunity Editionのバージョンがv1.6.0以上である必要があります。
</Info>

1. Difyコンソールにログインし、監視したいアプリケーションに移動します。
2. 左側のナビゲーションバーで**Monitoring**を開きます。
3. **Tracing app performance**をクリックし、**Cloud Monitor**エリアで**Configure**をクリックします。

![Alibaba Cloud Monitorの設定](https://dify-public-resources.oss-cn-hangzhou.aliyuncs.com/dify-doc/config_cms.png)

4. 表示されたダイアログで、手順1で取得した**License Key**と**Endpoint**を入力し、**App Name**（ARMSコンソールに表示されるアプリケーション名）をカスタマイズして**Save & Enable**をクリックします。

***

## Alibaba Cloud Monitorでの監視データの表示

設定後、Difyのアプリケーションからのデバッグまたは本番データはCloud Monitorで監視できます。

### 方法1: DifyアプリケーションからARMSコンソールにジャンプ

Difyコンソールでトレースが有効になっているアプリケーションを選択し、**Tracing Configuration**に移動して、**Cloud Monitor**エリアの**View**をクリックします。

### 方法2: ARMSコンソールで直接表示

ARMSコンソールの**LLM Application Monitoring > Application List**ページで、対応するDifyアプリケーションに移動します。

***

## より多くのデータにアクセス

Cloud Monitorは、Difyクラスターのさまざまなコンポーネントにアクセスしてエンドツーエンドのトレースを実現するマルチランゲージの非侵入型エージェントを提供します。

| Difyコンポーネント | エージェント | 詳細 |
|----------------|-------|---------|
| Nginx | OpenTelemetry Agent | [NginxトレースにOpenTelemetryを使用](https://www.alibabacloud.com/help/en/opentelemetry/user-guide/use-opentelemetry-to-perform-tracing-analysis-on-nginx?spm=a2c63.l28256.help-menu-search-90275.d_1) |
| API | LoongSuite-Python Agent | [loongsuite-python-agent](https://github.com/alibaba/loongsuite-python-agent/blob/main/README.md) |
| Sandbox | LoongSuite-Go Agent | [loongsuite-go-agent](https://github.com/alibaba/loongsuite-go-agent/blob/main/README.md) |
| Worker | OpenTelemetry Agent | [OpenTelemetryを介してPythonアプリケーションデータを送信](https://www.alibabacloud.com/help/en/opentelemetry/user-guide/use-managed-service-for-opentelemetry-to-submit-the-trace-data-of-python-applications?spm=a2c63.p38356.help-menu-90275.d_2_0_5_0.18ee53a4EGoGuS) |
| Plugin-Daemon | LoongSuite-Go Agent | [loongsuite-go-agent](https://github.com/alibaba/loongsuite-go-agent/blob/main/README.md) |

***

## 監視データリスト

Cloud Monitorは、DifyのWorkflow/Chatflow/Chat/Agentアプリケーションからデータを収集することをサポートしており、ワークフローおよびワークフローノードの実行詳細、モデル呼び出し、ツール呼び出し、知識取得、さまざまなプロセスノードの実行詳細、会話やユーザー情報などのメタデータをカバーしています。

### ワークフロー/Chatflowトレース情報

<table>
  <thead>
    <tr>
      <th>Workflow</th>
      <th>Alibaba Cloud Monitor Trace</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>workflow\_id</td>
      <td>ワークフローの一意の識別子</td>
    </tr>
    <tr>
      <td>conversation\_id</td>
      <td>会話ID</td>
    </tr>
    <tr>
      <td>workflow\_run\_id</td>
      <td>この実行のID</td>
    </tr>
    <tr>
      <td>tenant\_id</td>
      <td>テナントID</td>
    </tr>
    <tr>
      <td>elapsed\_time</td>
      <td>この実行の所要時間</td>
    </tr>
    <tr>
      <td>status</td>
      <td>実行ステータス</td>
    </tr>
    <tr>
      <td>version</td>
      <td>ワークフローのバージョン</td>
    </tr>
    <tr>
      <td>total\_tokens</td>
      <td>この実行で使用されたトークンの総数</td>
    </tr>
    <tr>
      <td>file\_list</td>
      <td>処理されたファイルのリスト</td>
    </tr>
    <tr>
      <td>triggered\_from</td>
      <td>この実行をトリガーしたソース</td>
    </tr>
    <tr>
      <td>workflow\_run\_inputs</td>
      <td>この実行の入力データ</td>
    </tr>
    <tr>
      <td>workflow\_run\_outputs</td>
      <td>この実行の出力データ</td>
    </tr>
    <tr>
      <td>error</td>
      <td>この実行中に発生したエラー</td>
    </tr>
    <tr>
      <td>query</td>
      <td>実行時に使用されたクエリ</td>
    </tr>
    <tr>
      <td>workflow\_app\_log\_id</td>
      <td>ワークフローアプリケーションログID</td>
    </tr>
    <tr>
      <td>message\_id</td>
      <td>関連するメッセージID</td>
    </tr>
    <tr>
      <td>start\_time</td>
      <td>実行開始時刻</td>
    </tr>
    <tr>
      <td>end\_time</td>
      <td>実行終了時刻</td>
    </tr>
  </tbody>
</table>

**ワークフロートレースメタデータ**

* workflow\_id - ワークフローの一意の識別子
* conversation\_id - 会話ID
* workflow\_run\_id - この実行のID
* tenant\_id - テナントID
* elapsed\_time - この実行の所要時間
* status - 実行ステータス
* version - ワークフローのバージョン
* total\_tokens - この実行で使用されたトークンの総数
* file\_list - 処理されたファイルのリスト
* triggered\_from - トリガーソース

### メッセージトレース情報

<table>
  <thead>
    <tr>
      <th>Message</th>
      <th>Alibaba Cloud Monitor Trace</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>message\_id</td>
      <td>メッセージID</td>
    </tr>
    <tr>
      <td>message\_data</td>
      <td>メッセージデータ</td>
    </tr>
    <tr>
      <td>user\_session\_id</td>
      <td>ユーザーのsession\_id</td>
    </tr>
    <tr>
      <td>conversation\_model</td>
      <td>会話モデル</td>
    </tr>
    <tr>
      <td>message\_tokens</td>
      <td>メッセージ内のトークン数</td>
    </tr>
    <tr>
      <td>answer\_tokens</td>
      <td>回答内のトークン数</td>
    </tr>
    <tr>
      <td>total\_tokens</td>
      <td>メッセージと回答のトークンの総数</td>
    </tr>
    <tr>
      <td>error</td>
      <td>エラー情報</td>
    </tr>
    <tr>
      <td>inputs</td>
      <td>入力データ</td>
    </tr>
    <tr>
      <td>outputs</td>
      <td>出力データ</td>
    </tr>
    <tr>
      <td>file\_list</td>
      <td>処理されたファイルのリスト</td>
    </tr>
    <tr>
      <td>start\_time</td>
      <td>開始時刻</td>
    </tr>
    <tr>
      <td>end\_time</td>
      <td>終了時刻</td>
    </tr>
    <tr>
      <td>message\_file\_data</td>
      <td>メッセージに関連するファイルデータ</td>
    </tr>
    <tr>
      <td>conversation\_mode</td>
      <td>会話モード</td>
    </tr>
  </tbody>
</table>

**メッセージトレースメタデータ**

* conversation\_id - メッセージが属する会話のID
* ls\_provider - モデルプロバイダー
* ls\_model\_name - モデルID
* status - メッセージステータス
* from\_end\_user\_id - 送信ユーザーのID
* from\_account\_id - 送信アカウントのID
* agent\_based - エージェントベースかどうか
* workflow\_run\_id - ワークフロー実行ID
* from\_source - メッセージソース
* message\_id - メッセージID

### データセット取得トレース情報

<table>
  <thead>
    <tr>
      <th>Dataset Retrieval</th>
      <th>Alibaba Cloud Monitor Trace</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>message\_id</td>
      <td>メッセージID</td>
    </tr>
    <tr>
      <td>inputs</td>
      <td>入力コンテンツ</td>
    </tr>
    <tr>
      <td>documents</td>
      <td>ドキュメントデータ</td>
    </tr>
    <tr>
      <td>start\_time</td>
      <td>開始時刻</td>
    </tr>
    <tr>
      <td>end\_time</td>
      <td>終了時刻</td>
    </tr>
    <tr>
      <td>message\_data</td>
      <td>メッセージデータ</td>
    </tr>
  </tbody>
</table>

**データセット取得トレースメタデータ**

* message\_id - メッセージID
* ls\_provider - モデルプロバイダー
* ls\_model\_name - モデルID
* status - メッセージステータス
* from\_end\_user\_id - 送信ユーザーのID
* from\_account\_id - 送信アカウントのID
* agent\_based - エージェントベースかどうか
* workflow\_run\_id - ワークフロー実行ID
* from\_source - メッセージソース

### ツールトレース情報

<table>
  <thead>
    <tr>
      <th>Tool</th>
      <th>Alibaba Cloud Monitor Trace</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>message\_id</td>
      <td>メッセージID</td>
    </tr>
    <tr>
      <td>tool\_name</td>
      <td>ツール名</td>
    </tr>
    <tr>
      <td>start\_time</td>
      <td>開始時刻</td>
    </tr>
    <tr>
      <td>end\_time</td>
      <td>終了時刻</td>
    </tr>
    <tr>
      <td>tool\_inputs</td>
      <td>ツール入力</td>
    </tr>
    <tr>
      <td>tool\_outputs</td>
      <td>ツール出力</td>
    </tr>
    <tr>
      <td>message\_data</td>
      <td>メッセージデータ</td>
    </tr>
    <tr>
      <td>error</td>
      <td>エラー情報（該当する場合）</td>
    </tr>
    <tr>
      <td>inputs</td>
      <td>メッセージの入力コンテンツ</td>
    </tr>
    <tr>
      <td>outputs</td>
      <td>メッセージの回答コンテンツ</td>
    </tr>
    <tr>
      <td>tool\_config</td>
      <td>ツール設定</td>
    </tr>
    <tr>
      <td>time\_cost</td>
      <td>コスト時間</td>
    </tr>
    <tr>
      <td>tool\_parameters</td>
      <td>ツールパラメータ</td>
    </tr>
    <tr>
      <td>file\_url</td>
      <td>関連ファイルのURL</td>
    </tr>
  </tbody>
</table>

**ツールトレースメタデータ**

* message\_id - メッセージID
* tool\_name - ツール名
* tool\_inputs - ツール入力
* tool\_outputs - ツール出力
* tool\_config - ツール設定
* time\_cost - コスト時間
* error - エラー情報
* tool\_parameters - ツールパラメータ
* message\_file\_id - メッセージファイルID
* created\_by\_role - 作成者の役割
* created\_user\_id - 作成者のユーザーID