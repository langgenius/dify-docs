---
title: "第 8 课：Agent 节点"
sidebarTitle: 第 8 课
---
经过前面七课的学习，我们的“邮件助理”已经经历了几次重大升级：
它学会了查阅资料 —— 知识库检索；
它学会了区分情况 —— 条件判断；
它学会了处理多个任务 —— 参数提取 + 迭代；
它还学会了使用工具来延展 —— 工具节点。

你会发现，我们的工作流不再是简单的一步接一步，而是变得越来越像一个能够自主分析、判断、并调用不同能力来解决问题的智能助手。这种更高级的工作流模式，正是我们今天要深入探讨的核心概念——Agentic Workflow。

**Agentic Workflow 与 Agent 策略（Strategies）**
Agentic Workflow 不再是简单的“输入\>处理\>输出”，而是包含了思考、规划、使用工具、根据结果调整等一系列更智能步骤的工作流。它让 AI 从一个简单的“执行者”变成了一个能自主解决问题的“智能体 (Agent)”。

**Agent 策略 （Strategies）**  
为了让 Agent 更聪明地工作，研究者们设计了很多“思考模式”，这些策略像锦囊妙计一样，指导 Agent 如何一步步解决复杂问题。
常见的策略包括：
- ReAct (Reason + Act)：边思考边行动。Agent 会先思考“我该做什么？”，然后执行一步（比如调用工具），观察结果，再根据结果进行下一步思考和行动，如此循环往复。
- Plan-and-Execute (规划与执行)：先制定详细的计划，再一步步严格执行计划。
- Chain of Thought (CoT - 思维链)：引导 AI 在回答问题前，先进行一步步的推理分析，把“思考过程”写出来，从而提高最终答案的准确性。
- Self-Correction / Reflection (自我修正/反思)：让 AI 对自己生成的初步结果进行审视和评估，发现其中的问题并进行修正。
- Memory (记忆)：为 Agent 配备短期或长期记忆机制，让它能记住之前的对话内容或关键信息，做出更连贯、更个性化的反应。

在第七课中，我们花费了较多的时间对迭代的子流程进行升级，那我们有无更加简单的办法，让 AI 能够先查资料，查不到再上网搜索，最后再进行整合办法呢？

答案是：使用 Dify 内的 Agent 节点 😉。

## Agent 节点
你可以把它看作一个高度封装的智能单元。
你只需要给它通过指令给它设定一个目标 (Goal)，并提供它可能需要用到的工具 (Tools)，它就能在内部自主地思考、规划、选择并调用工具（利用选定的“Agent 策略”，如 ReAct，以及模型的 Function Calling 能力），直到完成你设定的目标。
在 Dify 中，这极大地简化了构建复杂 Agentic Workflow 的过程。

## 动手实践1 使用 Agent 节点重构
我们的目标使用 Agent 节点替换掉迭代里的部分节点。
1. 让我们仅保留迭代节点里子流程的知识检索节点，移除其他节点。
<Frame>
  <img src="/images/difyworkflow101-lesson08-iteration.png" alt="Iteration" />
</Frame>
2. 添加 Agent 节点  
	在迭代节点里的知识检索节点后，添加 Agent 节点。
<Frame>
  <img src="/images/difyworkflow101-lesson08-addagentnode.png" alt="Add agent node" />
</Frame>
3. 安装 Agent 策略  
	由于我们还没有安装 Agent 策略，所以我们需要前往 Marketplace 进行安装。点击 Agent 节点，在右侧面板中点击 Agent 策略，点击在 Marketplace 中查找更多。
<Frame>
  <img src="/images/difyworkflow101-lesson08-searchagentstrategy.png" alt="Search agent strategy" />
</Frame>

4. 选择 Agent 策略  
	在 Dify Marketplace 页面里，点击 Agent 策略进入到对应插件页面，鼠标移动至 Dify Agent 策略。点击安装，并在弹窗中再次确认安装。
<Frame>
  <img src="/images/difyworkflow101-lesson08-chooseagentnode.png" alt="Choose agent strategy" />
</Frame>

5. 选择 ReAct  
	让我们回到工作流页面，如果此时 Agent 策略仍然为空，可以刷新页面。
点击 Agent 策略，选择 Agent 内的 ReAct。
<Frame>
  <img src="/images/difyworkflow101-lesson08-selectreact.png" alt="Select ReAct" />
</Frame>

**为什么选择 ReAct？ **
ReAct（Reason + Act）是一种非常强大且通用的 Agent 策略。它允许 Agent 像人一样思考：先推理 (Reason) 下一步该做什么（比如“我应该先查知识库”），然后行动 (Act)（调用知识库工具），观察结果后，再进行下一步推理（比如“知识库没找到，我需要搜索”）和行动（调用搜索工具）。这种“边想边做”的模式非常适合处理需要动态决策和多工具协作的复杂任务。

6. 选择模型  
	选择支持 Function Calling 的模型。我们可以选择 gpt-5。
<Frame>
  <img src="/images/difyworkflow101-lesson08-chooseamodel.png" alt="Choose a model" />
</Frame>

**为什么必须支持 Function Calling？ **
因为 Agent 节点的核心能力之一就是自主调用工具。Function Calling 是模型理解“何时”以及“如何”调用你提供的工具（如谷歌搜索）的关键技术。如果模型不支持此功能，Agent 就无法有效地与工具交互，也就失去了大部分自主决策的能力。

7. 选择工具  
	在工具列表中添加谷歌搜索，确认启用。
<Frame>
  <img src="/images/difyworkflow101-lesson08-addtool.png" alt="Add tool" />
</Frame>

8. 填写指令  
	请清晰地告诉 Agent，它的任务目标、角色、上下文以及需要遵循的工作里路程或者规则。
	在这里，我们需要告诉 Agent，现在已经有一份知识库检索结果，请在此基础上进行判断和做出下一步行动。你可以参考下面的指令，或者自行进行修改和补充。
	你的目标是回答用户提出的关于 Dify 产品的问题。

	请遵循以下步骤：
	我已经为你提供了一份相关的内部知识库检索 。请先判断这份结果是否能充分回答用户的问题`迭代/{x}item`：
	1. 如果上下文已能清晰回答，请直接基于上下文生成最终答案。
	2. 如果回答不充分或不相关，请使用谷歌搜索工具查找该问题的最新信息，并根据搜索结果生成最终答案。
	3. 最终答案需要简洁、准确。
<Frame>
  <img src="/images/difyworkflow101-lesson08-addinstructions.png" alt="Add instructions" />
</Frame>

9. 上下文和查询  
	在指令中，我们要求 Agent 根据上下文进行判定。接下来，我们需要在上下文框内，选择对应的知识检索结果。这样，Agent 节点才能基于上下文进行判定，再决定是否需要使用谷歌工具。
	上下文：选择知识检索内的 {x} result。
<Frame>
  <img src="/images/difyworkflow101-lesson08-contextandquery.png" alt="Context and query" />
</Frame>
查询：选择`迭代/{x} item` 。

为什么是 item，而不是最开始的 `email_content` 呢？
让我们快速回忆一下，我们使用参数提取器从 `email_content` 中提取了除了一个问题列表 `question_list`。现在，迭代节点正在逐一处理这个问题列表，而迭代里的 item 就是当前在处理的一个个问题。将 item 作为查询输入，能让 Agent 更聚焦于当前的任务，提高其决策和行动的准确性。

10. 设置迭代的输出变量  
	选择 `Agent/{x}textString`作为输出变量。
<Frame>
  <img src="/images/difyworkflow101-lesson08-iterationoutput.png" alt="Set iteration output" />
</Frame>
🎉 我们完成了迭代节点的所有升级操作。

由于迭代节点会为邮件中的每个问题都产生一个答案，继而输出一个包含所有问题答案的列表。所以我们需要在最后对这些答案进行一个总结，最终形成一份通顺和完整的邮件回复。

## 动手实践 2 最后的拼装
1. 添加 LLM 节点作为总结  
	在迭代节点后增加一个 LLM 节点，作为最终的邮件“最终撰写人”。点击该节点，在右侧的 System 里输入 Prompt。你可以参考下面的 Prompt，或自行修改。
	请注意：一定要包含上一步迭代节点的最终输出哦。
	Combine all answers from `Iteration/{x}output` (one answer per question) with the original email `User input/{x}email_content`.
	Write a complete, clear, and friendly email reply to `User Input/{x}customer_name`.
	Signature: Anne

2. 在 LLM 后添加输出节点，点击后在右侧面板的输出变量内选择 LLM 内的 {x} text，并将其命名为 email\_reply。
<Frame>
  <img src="/images/difyworkflow101-lesson08-addoutputnode.png" alt="Add output node" />
</Frame>

现在你可以运行这个工作流，并观察最终邮件是否对你提出的问题都进行了回答。
<Frame>
  <img src="/images/difyworkflow101-lesson08-finalworkflow.png" alt="Final workflow" />
</Frame>

## 小挑战和延展思考
1. 我们能否让 Agent 节点直接替换掉迭代节点？应该怎么样进行编排？
2. 上下文还能选择哪些信息，帮助 Agent 更好地运行？